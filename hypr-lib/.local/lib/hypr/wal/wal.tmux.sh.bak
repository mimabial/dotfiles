#!/usr/bin/env bash
# wal.tmux.sh - Apply pywal16 colors to tmux with theme override support

# Source pywal16 colors
if [ ! -f ~/.cache/wal/colors.sh ]; then
  echo "[tmux] Error: pywal16 colors not found"
  exit 1
fi
source ~/.cache/wal/colors.sh

# Map pywal colors to tmux theme variables
# Note: Theme-specific tmux colors are handled by color.set.sh processing tmux.theme files
tmux_bg="$color0"
tmux_fg="$color15"
tmux_accent="$color4"
tmux_gray="$color8"
tmux_highlight="$color4"
tmux_red="$color1"
tmux_green="$color2"
tmux_yellow="$color3"
tmux_blue="$color4"
tmux_magenta="$color5"
tmux_cyan="$color6"

# Generate colors-tmux.conf
cat > ~/.cache/wal/colors-tmux.conf << EOF
# ============================================================================
# Standard 16 color palette (from pywal16)
# ============================================================================
set -g @color0 "$color0"     # black
set -g @color1 "$color1"     # red
set -g @color2 "$color2"     # green
set -g @color3 "$color3"     # yellow
set -g @color4 "$color4"     # blue
set -g @color5 "$color5"     # magenta
set -g @color6 "$color6"     # cyan
set -g @color7 "$color7"     # white
set -g @color8 "$color8"     # bright black (gray)
set -g @color9 "$color9"     # bright red
set -g @color10 "$color10"   # bright green
set -g @color11 "$color11"   # bright yellow
set -g @color12 "$color12"   # bright blue
set -g @color13 "$color13"   # bright magenta
set -g @color14 "$color14"   # bright cyan
set -g @color15 "$color15"   # bright white

# ============================================================================
# Semantic color aliases
# ============================================================================
set -g @theme_bg "${tmux_bg:-$color0}"
set -g @theme_fg "${tmux_fg:-$color15}"
set -g @theme_accent "${tmux_accent:-$color4}"
set -g @theme_gray "${tmux_gray:-$color8}"
set -g @theme_highlight "${tmux_highlight:-$color4}"
set -g @theme_red "${tmux_red:-$color1}"
set -g @theme_green "${tmux_green:-$color2}"
set -g @theme_yellow "${tmux_yellow:-$color3}"
set -g @theme_blue "${tmux_blue:-$color4}"
set -g @theme_magenta "${tmux_magenta:-$color5}"
set -g @theme_cyan "${tmux_cyan:-$color6}"

# ============================================================================
# Tmux color settings
# ============================================================================
set -g status-style "bg=${tmux_bg:-$color0},fg=${tmux_fg:-$color15}"
set -g message-style "bg=${tmux_bg:-$color0},fg=${tmux_accent:-$color4}"
set -g message-command-style "bg=${tmux_bg:-$color0},fg=${tmux_accent:-$color4}"
set -g pane-border-style "fg=${tmux_gray:-$color8}"
set -g pane-active-border-style "fg=${tmux_accent:-$color4}"
set -g mode-style "bg=${tmux_accent:-$color4},fg=${tmux_bg:-$color0}"
set -g window-status-style "fg=${tmux_gray:-$color8}"
set -g window-status-current-style "fg=${tmux_accent:-$color4},bold"
set -g clock-mode-colour "${tmux_accent:-$color4}"
EOF

# Generate status.tmux.conf
cat > ~/.cache/wal/status.tmux.conf << EOF
session_fg="default"
session_bg="default"

# --- pane-border configuration ------------------------------------------------
setw -g pane-border-status top
tmux_pane_name="#(sleep 0.5; ps -t #{pane_tty} -o args= | head -n 2)"
tmux_pane_name_icons="#(\$(sleep 0.5; tmux-icons \$(ps -t #{pane_tty} -o args= | head -n 2))"
setw -g pane-border-format "\${tmux_pane_name_icons}"
setw -g pane-border-style "fg=${tmux_gray:-$color8},bg=default"
setw -g pane-active-border-style "fg=${tmux_highlight:-$color4},bg=default"

set -g pane-border-indicators colour
setw -g pane-border-lines single

setw -g window-active-style "fg=default,bg=default"
setw -g window-status-activity-style none
setw -g window-status-bell-style "fg=${tmux_red:-$color1},bg=${tmux_gray:-$color8},dim"
setw -g window-status-separator ""

set -g clock-mode-colour "${tmux_fg:-$color15}"
set -g mode-style "fg=${tmux_bg:-$color0},bg=${tmux_fg:-$color15}"

# colorize messages in the command line
set -g status-style "fg=${tmux_gray:-$color8},bg=default"
set -g message-command-style "fg=${tmux_green:-$color2} bg=terminal,bold,blink"
set -g message-style "fg=${tmux_red:-$color1} bg=terminal,italics,bold"

# -- popup style
set -g popup-style "bg=${tmux_gray:-$color8}"
set -g popup-border-style "fg=${tmux_gray:-$color8},bg=${tmux_gray:-$color8}"
set -g popup-border-lines "padded"

# = layout --
sep="⋮"
status_sep="#[fg=${tmux_accent:-$color4},bg=terminal]\$sep#[fg=default,bg=default]"

zoom_icon="#{?window_zoomed_flag,#[fg=${tmux_red:-$color1}]#(\$HOME/.local/bin/tmux-fancy-numbers\ #P),#{?#{>:#{window_panes},1},}} "
superscript_pane_count="#(echo #{window_panes} | sed 's/0/⁰/g;s/1/¹/g;s/2/²/g;s/3/³/g;s/4/⁴/g;s/5/⁵/g;s/6/⁶/g;s/7/⁷/g;s/8/⁸/g;s/9/⁹/g')"
status_items="#[default]#{?window_bell_flag,#[fg=${tmux_red:-$color1}] 󰂞,}\$zoom_icon"

# - left -
set -g status-left "#[bold]#[fg=default,bg=${tmux_gray:-$color8}]#{tmux_mode_indicator}"
set -g status-left-length 500

# - windows -
setw -g window-status-style "fg=${tmux_gray:-$color8}"
setw -g window-status-current-style "bg=default,fg=#{?\$session_fg,\${session_fg},${tmux_accent:-$color4}}"
setw -g window-status-current-format "#[italics,bold]#[fg=${tmux_accent:-$color4},bg=terminal]  #I:#W\$superscript_pane_count\$status_items"
setw -g window-status-format "  #I:#W\$superscript_pane_count\$status_items"

# - right -
cpu_temp="#[fg=${tmux_gray:-$color8}]#(\$XDG_CONFIG_HOME/tmux/scripts/cpu-temp.sh)"
gpu_temp="#[fg=${tmux_gray:-$color8}]#( awk '{printf(\"%.0f°C\", \\\$1/1000)}' /sys/class/hwmon/hwmon3/temp1_input )"
battery="#{?#{!=:#{battery_percentage},0},#[nobold,fg=#{battery_color_fg}]#{battery_icon} #{battery_percentage}#[default],}#[default]"
pomodoro="#[bold]#{pomodoro_status}#[default]"

ram="#[bold]#{ram_fg_color}#{ram_icon}\${reset}"
cpu="#[bold]#{cpu_fg_color}#{cpu_percentage}\${reset}"
pomodoro_display="#{pomodoro_status} #[default]"
tunes="#(\$HOME/.config/tmux/scripts/tmux-player)"
tunes_display="#[fg=\$thm_grey]#{?\$tunes,\${tunes} #[fg=${tmux_accent:-$color4}]\$sep ,}"
battery_display="#[bg=default,nobold]#{battery_color_fg}#[bg=default,nobold]#{battery_percentage} #{battery_icon_status}"
time="#[fg=${tmux_accent:-$color4}] #(TZ='/usr/share/zoneinfo/US/Eastern' date +'%H:%M') #[fg=${tmux_fg:-$color15}]"
utc="UTC #[fg=${tmux_gray:-$color8}]#(TZ='/usr/share/zoneinfo/UTC' date '+%%H:%%M')"
pst="PST #[fg=${tmux_gray:-$color8}]#(TZ='/usr/share/zoneinfo/US/Pacific' date '+%%H:%%M')"
alt_times="#[fg=${tmux_gray:-$color8}](\$utc#[fg=${tmux_gray:-$color8}])"

set -g status-right "\$battery\${tunes_display}\${pomodoro_display}\$status_sep\$cpu\$ram "
set -g status-right-length 200
EOF

echo "[tmux] Generated tmux color configs"

# Reload tmux if running
if command -v tmux &>/dev/null && tmux list-sessions &>/dev/null; then
  tmux source-file ~/.config/tmux/tmux.conf 2>/dev/null && echo "[tmux] Reloaded tmux config"
fi
